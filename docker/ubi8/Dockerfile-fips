FROM registry.access.redhat.com/ubi8/ubi:8.8 as java-builder
LABEL maintainer="OpsMx"

ARG JAVA_PACKAGE=java-17-openjdk-jmods
RUN yum -y update && yum -y install --nodocs ${JAVA_PACKAGE}

# Build a custom JRE.
# For now, we will include all modules.  We could try to remove the ones
# we don't need to reduce image size and security attack surface.
WORKDIR /jrebuild
RUN java --list-modules | cut -d'@' -f1 > modules
RUN jlink --output runtime --add-modules `paste -sd, - < modules` --compress 2 --vm server

# Build a minimal base image with our custom Java installed.

FROM registry.access.redhat.com/ubi8/ubi:8.8 AS java-base
LABEL maintainer="OpsMx"
COPY --from=java-builder /jrebuild/runtime /${CUSTOMPLUGIN_RELEASEORG}-java-runtime
ARG OPSMXUSER=1001
ENV JAVA_HOME=/${CUSTOMPLUGIN_RELEASEORG}-java-runtime \
    PATH=${PATH}:/${CUSTOMPLUGIN_RELEASEORG}-java-runtime/bin \
    WORK_DIR=/${CUSTOMPLUGIN_RELEASEORG}/workdir \
    CONF_DIR=/${CUSTOMPLUGIN_RELEASEORG}/conf
ENV SERVICE_PLUGIN_PATH=/opt/gate/plugins

# Enabling fips mode
RUN fips-mode-setup --enable

# Setting crypto policies to FIPS
RUN update-crypto-policies --set FIPS

COPY ./gate-web/build/install/gate /opt/gate
#RUN yum -y install java-17-openjdk-devel vim curl net-tools nettle

RUN yum -y install  wget 

RUN yum -y remove  tar  
RUN yum -y remove clean all && rm -rf /var/cache

RUN adduser spinnaker
RUN mkdir -p ${SERVICE_PLUGIN_PATH} && mkdir -p /opt/spinnaker/plugins

#custom plugin zip files adding
ARG CUSTOMPLUGIN_RELEASEORG
ENV CUSTOMPLUGIN_RELEASEORG=$CUSTOMPLUGIN_RELEASEORG
ARG CUSTOMPLUGIN_RELEASEVERSION
ENV CUSTOMPLUGIN_RELEASEVERSION=$CUSTOMPLUGIN_RELEASEVERSION
ARG CUSTOMPLUGIN_RELEASE_VERSION
ENV CUSTOMPLUGIN_RELEASE_VERSION=$CUSTOMPLUGIN_RELEASE_VERSION
ARG CUSTOMPLUGIN_RELEASEREPO
ENV CUSTOMPLUGIN_RELEASEREPO=$CUSTOMPLUGIN_RELEASEREPO

RUN wget -O Armory.armory-observability-plugin-1.0.1.zip -c https://github.com/opsmx/armory-observability-plugin/releases/download/v1.0.1/armory-observability-plugin-v1.0.1.zip -P /opt/gate/plugins
RUN mv Armory.armory-observability-plugin-1.0.1.zip /opt/gate/plugins

#COPY custom-plugin.json /opt/spinnaker/plugins/plugins.json

RUN chown -R spinnaker:spinnaker /opt/spinnaker
RUN yum -y remove tar vim vi
RUN chmod -R 777 /opt/gate/plugins/
RUN chown -R spinnaker:spinnaker /opt/
USER spinnaker
CMD ["/opt/gate/bin/gate"]  
